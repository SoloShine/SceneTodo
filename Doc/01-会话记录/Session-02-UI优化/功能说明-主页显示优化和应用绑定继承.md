# 主页待办项显示优化和应用绑定继承功能说明

## ?? 更新内容总结

### 1. 主页待办项显示优化 ?

#### 新增显示元素

**优先级标签**
- 显示位置：待办内容右侧
- 显示样式：彩色圆角标签，背景色根据优先级自动变化
- 文本内容：优先级描述（极低、低、中、高、极高）
- 颜色映射：
  - 极高：深红色 (#8B0000)
  - 高：红色
  - 中：橙色
  - 低：灰色
  - 极低：浅灰色

**子项数量标签**
- 显示位置：优先级标签右侧
- 显示条件：只有当待办项有子项时才显示
- 显示样式：蓝色圆角标签
- 图标：??
- 文本内容：子项数量

**时间信息行**
- 显示位置：待办内容下方
- 显示字段：
  - ?? 开始时间：计划开始时间
  - ?? 结束时间：计划结束时间
  - ? 提醒时间：提醒时间（橙色高亮）
  - ?? 更新时间：最后更新时间（灰色）
- 显示条件：只有设置了相应时间的字段才显示
- 字体大小：11px，灰色文本

**布局改进**
- 从单行布局改为两行布局
- 第一行：复选框 + 图标 + 内容 + 标签 + 关联操作 + 操作按钮
- 第二行：时间信息
- 边框内边距增加，整体更加清晰

---

### 2. 应用绑定继承功能 ???

#### 核心规则

**根级待办项**
- ? 可以自由设置应用类型（普通待办/软件待办）
- ? 可以选择绑定的应用程序
- ? 可以设置遮盖层位置和偏移量
- ? 所有应用绑定相关设置都可以修改

**子级待办项**
- ? 自动继承父级的应用绑定信息
  - AppPath（应用路径）
  - Name（应用名称）
  - TodoItemType（待办类型）
  - IsInjected（注入状态）
  - OverlayPosition（遮盖层位置）
  - OverlayOffsetX/Y（偏移量）
- ? 不能修改应用绑定信息（控件被禁用）
- ?? 编辑界面显示"应用路径 (继承自父级):"提示
- ?? 应用相关输入框显示灰色背景，表示不可编辑
- ? 可以修改其他信息：
  - 内容（Content）
  - 描述（Description）
  - 优先级（Priority）
  - 时间字段（StartTime, EndTime, ReminderTime）
  - 关联操作（LinkedActions）

#### 实现细节

**创建子待办项时**
```csharp
// 自动继承父级的应用绑定信息
var item = new TodoItemModel()
{
    Id = Guid.NewGuid().ToString(),
    Content = "新子待办项",
    IsCompleted = false,
    ParentId = parentItem.Id,  // 标记为子项
    IsExpanded = true,
    Name = parentItem.Name,         // 继承父级名称
    AppPath = parentItem.AppPath,   // 继承父级路径
    IsInjected = parentItem.IsInjected,  // 继承注入状态
    TodoItemType = parentItem.TodoItemType  // 继承待办类型
};
```

**编辑子待办项时**
```csharp
// 检查是否为子级待办项
bool isChildItem = !string.IsNullOrEmpty(todo.ParentId);

if (isChildItem)
{
    // 禁用应用绑定相关控件
    AppTypeComboBox.IsEnabled = false;
    AppPathTextBox.IsEnabled = false;
    AppNameTextBox.IsEnabled = false;
    SelectAppButton.IsEnabled = false;
    OverlayPositionComboBox.IsEnabled = false;
    OverlayOffsetXNumericUpDown.IsEnabled = false;
    OverlayOffsetYNumericUpDown.IsEnabled = false;
    
    // 显示灰色背景
    AppPathTextBox.Background = Brushes.LightGray;
    AppNameTextBox.Background = Brushes.LightGray;
}
```

**保存时的逻辑**
```csharp
// 只有根级待办项才能修改应用绑定信息
if (!isChildItem)
{
    Todo.AppPath = AppPathTextBox.Text;
    Todo.Name = AppNameTextBox.Text;
    Todo.OverlayPosition = GetSelectedOverlayPosition();
    Todo.OverlayOffsetX = OverlayOffsetXNumericUpDown.Value;
    Todo.OverlayOffsetY = OverlayOffsetYNumericUpDown.Value;
}
// 子级待办项保持从父级继承的应用绑定信息不变
```

---

### 3. 新增转换器

**EnumToDescriptionConverter**
- 功能：将枚举值转换为Description特性的文本
- 用途：显示优先级的中文描述

**Int2VisibilityConverter**
- 功能：整数大于0时显示，否则隐藏
- 用途：子项数量标签的显示控制

**NullableToVisibilityConverter**
- 功能：Nullable值不为空时显示，否则隐藏
- 用途：时间字段的显示控制

---

## ?? 视觉效果对比

### 优化前
```
[?] 待办内容                                              2024-01-01  [编辑][添加][删除]
```

### 优化后
```
[?] ?? 待办内容  [中] [?? 3]  [打开链接]              [编辑][添加][删除]
    ?? 开始: 2024-01-01 09:00  ?? 结束: 2024-01-01 18:00  ? 提醒: 2024-01-01 08:30
```

---

## ?? 使用场景示例

### 场景1：为Visual Studio创建待办项

1. 创建根级待办项"VS开发任务"
   - 设置应用类型：软件待办
   - 选择应用：Visual Studio
   - 设置遮盖层位置：右下角

2. 添加子待办项：
   - "完成登录功能" - 自动继承VS绑定
   - "修复注册bug" - 自动继承VS绑定
   - "优化性能" - 自动继承VS绑定

3. 所有子待办项：
   - ? 都会显示在VS的遮盖层上
   - ? 共享同一个遮盖层位置设置
   - ? 不能单独修改应用绑定
   - ? 可以修改自己的优先级、时间等

### 场景2：多应用场景

**正确做法** ?
```
根节点1: "Chrome开发任务" (绑定Chrome)
  └─ 子项1-1: "测试网站A"
  └─ 子项1-2: "测试网站B"

根节点2: "VS Code开发任务" (绑定VS Code)
  └─ 子项2-1: "编写文档"
  └─ 子项2-2: "修改配置"
```

**错误做法** ?
```
根节点: "开发任务" (绑定Chrome)
  └─ 子项1: "Chrome任务" (尝试修改为Chrome) ← 不允许
  └─ 子项2: "VS Code任务" (尝试修改为VS Code) ← 不允许
```

---

## ?? 技术实现细节

### 文件变更列表

**新增文件**
- `Converters/EnumToDescriptionConverter.cs`
- `Converters/Int2VisibilityConverter.cs`
- `Converters/NullableToVisibilityConverter.cs`

**修改文件**
- `Views/TodoItemControl.xaml` - 优化显示布局
- `Views/EditTodoItemWindow.xaml.cs` - 添加应用绑定继承逻辑
- `App.xaml` - 注册新的转换器

**保持不变**
- `ViewModels/MainWindowViewModel.cs` - AddTodoItem已有继承逻辑
- `Models/TodoItem.cs` - 数据模型无需修改

---

## ? 测试检查清单

### 显示优化测试
- [ ] 优先级标签正确显示，颜色符合优先级
- [ ] 子项数量标签在有子项时显示，数量正确
- [ ] 时间信息只在设置了时间时显示
- [ ] 提醒时间显示为橙色高亮
- [ ] 关联操作按钮正常显示和点击

### 应用绑定继承测试
- [ ] 创建根级待办项，可以自由设置应用绑定
- [ ] 创建子级待办项，自动继承父级应用绑定
- [ ] 编辑子级待办项，应用绑定相关控件被禁用
- [ ] 编辑子级待办项，显示"继承自父级"提示
- [ ] 保存子级待办项，应用绑定信息未被修改
- [ ] 修改父级应用绑定，子级需要重启应用后生效
- [ ] 多层级嵌套（孙级节点），继承正确

### 边界情况测试
- [ ] 没有设置任何时间的待办项显示正常
- [ ] 没有子项的待办项不显示子项标签
- [ ] 根级待办项可以从有应用绑定改为无应用绑定
- [ ] 子级待办项的其他字段（优先级、时间等）可以正常修改

---

## ?? 已知限制

1. ?? 修改父级的应用绑定后，子级的绑定信息在当前会话中不会自动更新
   - 解决方案：重启应用或重新加载数据库

2. ?? 子项数量标签不会实时更新
   - 当前：只在加载时计算一次
   - 改进：可以监听SubItems集合的变化

3. ?? 时间显示格式固定
   - 当前：使用DateTimeToStringConverter的默认格式
   - 改进：可以支持自定义格式

---

## ?? 设计理念

### 为什么只有根级可以绑定应用？

1. **避免冲突**：一个应用的遮盖层不应该显示多个不同应用的待办项
2. **简化管理**：集中管理应用绑定，修改更容易
3. **逻辑清晰**：父子关系明确，子级"属于"父级的上下文
4. **用户友好**：避免误操作导致遮盖层显示混乱

### 为什么子级可以修改优先级和时间？

1. **灵活性**：每个子任务可能有不同的优先级和时间要求
2. **独立性**：虽然属于同一个应用，但任务本身是独立的
3. **实用性**：满足实际使用场景，如"高优先级bug修复"vs"低优先级功能优化"

---

## ?? 后续改进建议

### 短期改进
1. 添加子项数量的实时更新
2. 支持时间显示格式自定义
3. 添加"批量修改子项优先级"功能

### 长期改进
1. 支持"应用组"概念，一组待办项可以绑定多个应用
2. 支持子项"临时解绑"功能（在特殊情况下允许修改）
3. 支持拖拽调整待办项的父子关系

---

**更新日期**: 2025-01-XX  
**版本**: v1.0  
**创建**: GitHub Copilot
